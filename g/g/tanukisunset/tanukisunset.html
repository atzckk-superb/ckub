<!DOCTYPE html>
<html>
  <head>
    <title>Tanuki Sunset</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <script src="UnityLoader.js"></script>
   <script>
launchOffline("tanuki.zip", function() {
 window.gameInstance = UnityLoader.instantiate("gameContainer", "tanuki.json");
});

function launchOffline(zipJSFile, finalDone) {
 var startMain = function() {
  loadScript(`${zipJSFile}.js`, function() {
   setupFetch();
   setupXMLHttpRequest();
   
   window[zipJSFile].then(function(zipBlobURL) {
    fetch(zipBlobURL).then(function(resp) {
     resp.blob().then(function(blob) {
      uploadFile(blob, "readAsArrayBuffer", function(e) {
       readZipEntries(e.data).then(function(fileList) {
        window.fileList = fileList;
        finalDone();
       });
      });
     });
    });
   });
  });
 }
 if (!window["zip"]) {
  loadScript(`zip.min.js`, function() {
   startMain()
  });
 } else {
  startMain();
 }
}

function loadScript(src, callback) {
 var script = document.createElement("script");
 script.src = src;
 document.head.appendChild(script);
 script.onload = callback;
}

function setupFetch() {
 const originalFetch = window.fetch;
 window.fetch = function() {
  arguments[0] = changeURL(arguments[0]);
  return originalFetch.apply(this, arguments);
 };
}

function setupXMLHttpRequest() {
 const originalOpen = XMLHttpRequest.prototype.open;
 Object.defineProperty(XMLHttpRequest.prototype, "open", {
  value: function() {
   arguments[1] = changeURL(arguments[1]);
   return originalOpen.apply(this, arguments);
  }
 });
}

function changeURL(url) {
 if (window.fileList && window.fileList[url]) {
  url = window.fileList[url];
 }
 return url;
}

function readFile(file, readAs) {
 return new Promise(function(resolve) {
  var reader = new FileReader();
  reader.onload = function() {
   resolve(this.result);
  }
  reader[readAs](file);
 });
}

function readZipEntries(data) {
 return new Promise(function(resolve) {
  var reader = new zip.ZipReader(new zip.Uint8ArrayReader(new Uint8Array(data)));
  reader.getEntries().then(function(entries) {
   var readAll = [];
   var fileNames = [];

   entries.forEach(function(entry) {
    if (!entry.directory) {
     readAll.push(entry.getData(new zip.Uint8ArrayWriter()));
     fileNames.push(entry.filename);
    }
   });

   Promise.all(readAll).then(function(readFiles) {
    var fileList = createFileList(readFiles, fileNames);
    resolve(fileList);
   });
  });
 });
}

function createFileList(readFiles, fileNames) {
 var fileList = {};
 readFiles.forEach(function(readFile, i) {
  var fileName = fileNames[i];
  var mime = getMimeType(fileName);
  var blob = new Blob([readFile.buffer], {type: mime});
  var blobURL = URL.createObjectURL(blob);
  fileList[fileName] = blobURL;
 });
 return fileList;
}

function uploadFile(file, readAs, callback) {
 readFile(file, readAs || "readAsDataURL").then(function(data) {
  callback({
   name: file.name,
   data: data,
   mime: file.type,
   size: file.size
  });
 });
}

function getMimeType(fileName) {
 const extension = fileName.split('.').pop().toLowerCase();
 const mimeTypes = {
  txt: 'text/plain',
  json: 'application/json',
  csv: 'text/csv',
  xml: 'application/xml',
  html: 'text/html',
  htm: 'text/html',
  css: 'text/css',
  js: 'application/javascript',
  jpg: 'image/jpeg',
  jpeg: 'image/jpeg',
  png: 'image/png',
  gif: 'image/gif',
  svg: 'image/svg+xml',
  bmp: 'image/bmp',
  ico: 'image/x-icon',
  pdf: 'application/pdf',
  zip: 'application/zip',
  tar: 'application/x-tar',
  mp3: 'audio/mpeg',
  wav: 'audio/wav',
  mp4: 'video/mp4',
  avi: 'video/x-msvideo',
  doc: 'application/msword',
  docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  xls: 'application/vnd.ms-excel',
  xlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
  ppt: 'application/vnd.ms-powerpoint',
  pptx: 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
 };
 return mimeTypes[extension] || 'application/octet-stream';
}
    </script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <div class="webgl-content">
      <div id="gameContainer" style="width: 100%; height: 100%; margin: 0;"></div>
    </div>
  </body>
</html>