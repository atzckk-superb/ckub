
<!DOCTYPE html>
<html>
  <head>
    <style>
html, body, iframe {
 width: 100%;
 height: 100%;
 margin: 0;
 padding: 0;
}
    </style>
   <script>
window.hideProgress = function() {
 var prog = document.getElementById('prog');
 prog && prog.remove();
};

window.addEventListener("load", function() {
 var prog = document.createElement("h1");
 prog.textContent = "Status: Loading...";
 prog.id = "prog";
 document.body.appendChild(prog);
 var OGLOG = console.log;
 console.log = function() {
  if (!prog) {
   console.log = OGLOG;
   return OGLOG.apply(this, arguments);
  }
  var str = `Status: ${(Array.from(arguments)).toString()}`;
  prog.textContent = str;
  return OGLOG.apply(this, arguments);
 }
});

function launchOffline(zipJSFile, finalDone) {
 var startMain = function() {
  console.log("Starting launchOffline");
  loadScript(`${zipJSFile}.js`, function() {
   setupFetch();
   setupXMLHttpRequest();
   
   window[zipJSFile].then(function(zipBlobURL) {
    fetch(zipBlobURL).then(function(resp) {
     console.log("Fetched files");
     resp.blob().then(function(blob) {
      uploadFile(blob, "readAsArrayBuffer", function(e) {
       console.log("Reading Files...");
       readZipEntries(e.data).then(function(fileList) {
        window.fileList = fileList;
        finalDone();
        console.log("Running Done!");
        window.hideProgress();
       });
      });
     });
    });
   });
  });
 }
 
 var toLoad = [];
 
 if (!window["zip"]) {
  toLoad.push("zip.min.js");
 }
 if (!window["zip"]) {
  toLoad.push("getMimeType.min.js");
 }
 
 if (toLoad.length >= 1) {
  var loadAll = [];
  toLoad.forEach(function(e) {
   loadAll.push(new Promise(function(resolve) {
    loadScript(e, resolve)
   }));
  });
  Promise.all(loadAll).then(startMain);
 } else {
  startMain();
 }
}

function runInOrder(arr) {
 var r;
 var prom = new Promise(function(res) {
  r = res;
 });
 
 function loadScriptPromise(src) {
  return new Promise(function(resolve) {
   var script = document.createElement("script");
   script.src = src;
   document.body.appendChild(script);
   script.onload = function() {
    console.log("Loaded", src);
    resolve();
   };
  });
 }
 
 var currentIndex = 0;
 var loadNext = function() {
  if (currentIndex > arr.length - 1) {
   r();
   return;
  }
  
  loadScriptPromise(arr[currentIndex]).then(function() {
   currentIndex += 1;
   loadNext();
  });
 }
 
 loadNext();
 return prom;
}

function triggerLoadEvents() {
 const domContentLoadedEvent = new Event('DOMContentLoaded');
 document.dispatchEvent(domContentLoadedEvent);

 const loadEvent = new Event('load');
 window.dispatchEvent(loadEvent);
    
 const loadEvent2 = new Event('load');
 document.body.dispatchEvent(loadEvent2);
}

function loadScript(src, callback) {
 console.log(`Load script: "${src}"`);
 var script = document.createElement("script");
 script.src = src;
 document.head.appendChild(script);
 script.onload = function() {
  callback();
  console.log("Loaded", src);
 };
}

function setupFetch() {
 const originalFetch = window.fetch;
 window.fetch = function() {
  arguments[0] = changeURL(arguments[0]);
  return originalFetch.apply(this, arguments);
 };
}

function setupXMLHttpRequest() {
 const originalOpen = XMLHttpRequest.prototype.open;
 Object.defineProperty(XMLHttpRequest.prototype, "open", {
  value: function() {
   arguments[1] = changeURL(arguments[1]);
   return originalOpen.apply(this, arguments);
  }
 });
}

function changeURL(url) {
 if (window.fileList && window.fileList[url]) {
  url = window.fileList[url];
 }
 return url;
}

function readFile(file, readAs) {
 return new Promise(function(resolve) {
  var reader = new FileReader();
  reader.onload = function() {
   resolve(this.result);
  }
  reader[readAs](file);
 });
}

function readZipEntries(data) {
 return new Promise(function(resolve) {
  var reader = new zip.ZipReader(new zip.Uint8ArrayReader(new Uint8Array(data)));
  reader.getEntries().then(function(entries) {
   var readAll = [];
   var fileNames = [];

   entries.forEach(function(entry) {
    if (!entry.directory) {
     readAll.push(entry.getData(new zip.Uint8ArrayWriter()));
     fileNames.push(entry.filename);
    }
   });

   Promise.all(readAll).then(function(readFiles) {
    var fileList = createFileList(readFiles, fileNames);
    resolve(fileList);
   });
  });
 });
}

function createFileList(readFiles, fileNames) {
 var fileList = {};
 readFiles.forEach(function(readFile, i) {
  var fileName = fileNames[i];
  var mime = getMimeType(fileName);
  var blob = new Blob([readFile.buffer], {type: mime});
  var blobURL = URL.createObjectURL(blob);
  fileList[fileName] = blobURL;
 });
 return fileList;
}

function uploadFile(file, readAs, callback) {
 readFile(file, readAs || "readAsDataURL").then(function(data) {
  callback({
   name: file.name,
   data: data,
   mime: file.type,
   size: file.size
  });
 });
}

function makeFrame() {
 var frame = document.createElement("iframe");
 frame.setAttribute("frameborder","0");
 frame.setAttribute("allowfullscreen","true");
 document.body.appendChild(frame);
 return {
  frame: frame,
  frameWindow: frame.contentWindow||frame.contentDocument.document||frame.contentDocument
 };
}

launchOffline("cell-machine.zip", function() {
 var madeFrame = makeFrame();
 var frame = madeFrame.frame;
 var frameWindow = madeFrame.frameWindow;
 frameWindow.document.open();
 frameWindow.document.write(atob(`PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuLXVzIj4KICA8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9InV0Zi04Ij4KICAgIDxtZXRhIGh0dHAtZXF1aXY9IkNvbnRlbnQtVHlwZSIgY29udGVudD0idGV4dC9odG1sOyBjaGFyc2V0PXV0Zi04Ij4KICAgIDx0aXRsZT5DZWxsIE1hY2hpbmU8L3RpdGxlPgogICAgPGxpbmsgcmVsPSJzaG9ydGN1dCBpY29uIiBocmVmPSJpbWcvaWNvbi5wbmciPgogICAgPGxpbmsgcmVsPSJpY29uIiBocmVmPSJpbWcvaWNvbi5wbmciPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJUZW1wbGF0ZURhdGEvc3R5bGUuY3NzIj4KICAgIDxzY3JpcHQgc3JjPSJUZW1wbGF0ZURhdGEvVW5pdHlQcm9ncmVzcy5qcyI+PC9zY3JpcHQ+CiAgICA8c2NyaXB0IHNyYz0iQnVpbGQvVW5pdHlMb2FkZXIuanMiPjwvc2NyaXB0PgogICAgPHNjcmlwdCBzcmM9Ii9qcy9tYWluLmpzIj48L3NjcmlwdD4KICAgIDxzY3JpcHQ+CiAgICAgIHZhciB1bml0eUluc3RhbmNlID0gVW5pdHlMb2FkZXIuaW5zdGFudGlhdGUoInVuaXR5Q29udGFpbmVyIiwgIkJ1aWxkL3dlYnYwXzFfMS5qc29uIiwge29uUHJvZ3Jlc3M6IFVuaXR5UHJvZ3Jlc3N9KTsKICAgIDwvc2NyaXB0PgogIDwvaGVhZD4KICA8Ym9keT4KICAgIDxkaXYgY2xhc3M9IndlYmdsLWNvbnRlbnQiPgogICAgICA8ZGl2IGlkPSJ1bml0eUNvbnRhaW5lciIgc3R5bGU9IndpZHRoOiA5NjBweDsgaGVpZ2h0OiA1NDBweCI+PC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9ImZvb3RlciI+CiAgICAgICAgPGRpdiBjbGFzcz0iZnVsbHNjcmVlbiIgb25jbGljaz0idW5pdHlJbnN0YW5jZS5TZXRGdWxsc2NyZWVuKDEpIj48L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICA8L2JvZHk+CjwvaHRtbD4=`));
 
 const OGchangeURL = changeURL;
 window.changeURL = function(url) {
  console.log(url);
  var noSearch = url.split("?")[0];
  var noThisFolder = url.split("./")[1];
  if (!window.fileList[url] && window.fileList[noSearch]) {
   url = noSearch;
  }
  if (!window.fileList[url] && window.fileList[noThisFolder]) {
   url = noThisFolder;
  }
  return OGchangeURL(url);
 }
 
 const originalOpen = frameWindow.XMLHttpRequest.prototype.open;
 Object.defineProperty(frameWindow.XMLHttpRequest.prototype, "open", {
  value: function() {
   arguments[1] = changeURL(arguments[1]);
   return originalOpen.apply(this, arguments);
  }
 });
 
 frameWindow.document.close();
 frameWindow.fetch = window.fetch;
 frameWindow.fetch = window.fetch;
});
    </script>
  </head>
</html>
