
<!DOCTYPE html>
<html>
  <head>
    <style>
html, body, iframe {
 width: 100%;
 height: 100%;
 margin: 0;
 padding: 0;
}
    </style>
   <script>
window.hideProgress = function() {
 var prog = document.getElementById('prog');
 prog && prog.remove();
};

window.addEventListener("load", function() {
 var prog = document.createElement("h1");
 prog.textContent = "Status: Loading...";
 prog.id = "prog";
 document.body.appendChild(prog);
 var OGLOG = console.log;
 console.log = function() {
  if (!prog) {
   console.log = OGLOG;
   return OGLOG.apply(this, arguments);
  }
  var str = `Status: ${(Array.from(arguments)).toString()}`;
  prog.textContent = str;
  return OGLOG.apply(this, arguments);
 }
});

function launchOffline(zipJSFile, finalDone) {
 var startMain = function() {
  console.log("Starting launchOffline");
  loadScript(`${zipJSFile}.js`, function() {
   setupFetch();
   setupXMLHttpRequest();
   
   window[zipJSFile].then(function(zipBlobURL) {
    fetch(zipBlobURL).then(function(resp) {
     console.log("Fetched files");
     resp.blob().then(function(blob) {
      uploadFile(blob, "readAsArrayBuffer", function(e) {
       console.log("Reading Files...");
       readZipEntries(e.data).then(function(fileList) {
        window.fileList = fileList;
        finalDone();
        console.log("Running Done!");
        window.hideProgress();
       });
      });
     });
    });
   });
  });
 }
 
 var toLoad = [];
 
 if (!window["zip"]) {
  toLoad.push("zip.min.js");
 }
 if (!window["zip"]) {
  toLoad.push("getMimeType.min.js");
 }
 
 if (toLoad.length >= 1) {
  var loadAll = [];
  toLoad.forEach(function(e) {
   loadAll.push(new Promise(function(resolve) {
    loadScript(e, resolve)
   }));
  });
  Promise.all(loadAll).then(startMain);
 } else {
  startMain();
 }
}

function runInOrder(arr) {
 var r;
 var prom = new Promise(function(res) {
  r = res;
 });
 
 function loadScriptPromise(src) {
  return new Promise(function(resolve) {
   var script = document.createElement("script");
   script.src = src;
   document.body.appendChild(script);
   script.onload = function() {
    console.log("Loaded", src);
    resolve();
   };
  });
 }
 
 var currentIndex = 0;
 var loadNext = function() {
  if (currentIndex > arr.length - 1) {
   r();
   return;
  }
  
  loadScriptPromise(arr[currentIndex]).then(function() {
   currentIndex += 1;
   loadNext();
  });
 }
 
 loadNext();
 return prom;
}

function triggerLoadEvents() {
 const domContentLoadedEvent = new Event('DOMContentLoaded');
 document.dispatchEvent(domContentLoadedEvent);

 const loadEvent = new Event('load');
 window.dispatchEvent(loadEvent);
    
 const loadEvent2 = new Event('load');
 document.body.dispatchEvent(loadEvent2);
}

function loadScript(src, callback) {
 console.log(`Load script: "${src}"`);
 var script = document.createElement("script");
 script.src = src;
 document.head.appendChild(script);
 script.onload = function() {
  callback();
  console.log("Loaded", src);
 };
}

function setupFetch() {
 const originalFetch = window.fetch;
 window.fetch = function() {
  arguments[0] = changeURL(arguments[0]);
  return originalFetch.apply(this, arguments);
 };
}

function setupXMLHttpRequest() {
 const originalOpen = XMLHttpRequest.prototype.open;
 Object.defineProperty(XMLHttpRequest.prototype, "open", {
  value: function() {
   arguments[1] = changeURL(arguments[1]);
   return originalOpen.apply(this, arguments);
  }
 });
}

function changeURL(url) {
 if (window.fileList && window.fileList[url]) {
  url = window.fileList[url];
 }
 return url;
}

function readFile(file, readAs) {
 return new Promise(function(resolve) {
  var reader = new FileReader();
  reader.onload = function() {
   resolve(this.result);
  }
  reader[readAs](file);
 });
}

function readZipEntries(data) {
 return new Promise(function(resolve) {
  var reader = new zip.ZipReader(new zip.Uint8ArrayReader(new Uint8Array(data)));
  reader.getEntries().then(function(entries) {
   var readAll = [];
   var fileNames = [];

   entries.forEach(function(entry) {
    if (!entry.directory) {
     readAll.push(entry.getData(new zip.Uint8ArrayWriter()));
     fileNames.push(entry.filename);
    }
   });

   Promise.all(readAll).then(function(readFiles) {
    var fileList = createFileList(readFiles, fileNames);
    resolve(fileList);
   });
  });
 });
}

function createFileList(readFiles, fileNames) {
 var fileList = {};
 readFiles.forEach(function(readFile, i) {
  var fileName = fileNames[i];
  var mime = getMimeType(fileName);
  var blob = new Blob([readFile.buffer], {type: mime});
  var blobURL = URL.createObjectURL(blob);
  fileList[fileName] = blobURL;
 });
 return fileList;
}

function uploadFile(file, readAs, callback) {
 readFile(file, readAs || "readAsDataURL").then(function(data) {
  callback({
   name: file.name,
   data: data,
   mime: file.type,
   size: file.size
  });
 });
}

function makeFrame() {
 var frame = document.createElement("iframe");
 frame.setAttribute("frameborder","0");
 frame.setAttribute("allowfullscreen","true");
 document.body.appendChild(frame);
 return {
  frame: frame,
  frameWindow: frame.contentWindow||frame.contentDocument.document||frame.contentDocument
 };
}

launchOffline("gameinsideagame.zip", function() {
 var madeFrame = makeFrame();
 var frame = madeFrame.frame;
 var frameWindow = madeFrame.frameWindow;
 frameWindow.document.open();
 frameWindow.document.write(atob(`PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuLXVzIj4KICA8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9InV0Zi04Ij4KICAgIDxtZXRhIGh0dHAtZXF1aXY9IkNvbnRlbnQtVHlwZSIgY29udGVudD0idGV4dC9odG1sOyBjaGFyc2V0PXV0Zi04Ij4KICAgIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIHVzZXItc2NhbGFibGU9bm8sIG1pbmltdW0tc2NhbGU9MS4wLCBtYXhpbXVtLXNjYWxlPTEuMCIgLz4KICAgIDx0aXRsZT5HYW1lIEluc2lkZSBhIEdhbWU8L3RpdGxlPgogICAgPGxpbmsgcmVsPSJpY29uIiBocmVmPSJpbWcvaWNvbi5wbmciPgogICAgPGxpbmsgcmVsPSJzaG9ydGN1dCBpY29uIiBocmVmPSJpbWcvaWNvbi5wbmciPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJUZW1wbGF0ZURhdGEvc3R5bGUuY3NzIj4KICA8L2hlYWQ+CiAgPGJvZHk+CiAgICA8c2NyaXB0IHNyYz0iL2pzL21haW4uanMiPjwvc2NyaXB0PgogICAgPGRpdiBpZD0idW5pdHktY29udGFpbmVyIiBjbGFzcz0idW5pdHktZGVza3RvcCI+CiAgICAgIDxjYW52YXMgaWQ9InVuaXR5LWNhbnZhcyI+PC9jYW52YXM+CiAgICAgIDxkaXYgaWQ9InVuaXR5LWxvYWRpbmctYmFyIj4KICAgICAgICA8ZGl2IGlkPSJ1bml0eS1sb2dvIj48L2Rpdj4KICAgICAgICA8ZGl2IGlkPSJ1bml0eS1wcm9ncmVzcy1iYXItZW1wdHkiPgogICAgICAgICAgPGRpdiBpZD0idW5pdHktcHJvZ3Jlc3MtYmFyLWZ1bGwiPjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0idW5pdHktZm9vdGVyIj4KICAgICAgICA8ZGl2IGlkPSJ1bml0eS1mdWxsc2NyZWVuLWJ1dHRvbiI+PC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgICA8c2NyaXB0PgogICAgICB2YXIgYnVpbGRVcmwgPSAiQnVpbGQiOwogICAgICB2YXIgbG9hZGVyVXJsID0gYnVpbGRVcmwgKyAiL3dlYnYwXzJkLmxvYWRlci5qcyI7CiAgICAgIHZhciBjb25maWcgPSB7CiAgICAgICAgZGF0YVVybDogYnVpbGRVcmwgKyAiL3dlYnYwXzJkLmRhdGEiLAogICAgICAgIGZyYW1ld29ya1VybDogYnVpbGRVcmwgKyAiL3dlYnYwXzJkLmZyYW1ld29yay5qcyIsCiAgICAgICAgY29kZVVybDogYnVpbGRVcmwgKyAiL3dlYnYwXzJkLndhc20iLAogICAgICAgIHN0cmVhbWluZ0Fzc2V0c1VybDogIlN0cmVhbWluZ0Fzc2V0cyIsCiAgICAgICAgY29tcGFueU5hbWU6ICJTYW0gSG9nYW4iLAogICAgICAgIHByb2R1Y3ROYW1lOiAiR2FtZSBJbnNpZGUgYSBHYW1lIiwKICAgICAgICBwcm9kdWN0VmVyc2lvbjogIjAuMiIsCiAgICAgIH07CgogICAgICB2YXIgY29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI3VuaXR5LWNvbnRhaW5lciIpOwogICAgICB2YXIgY2FudmFzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI3VuaXR5LWNhbnZhcyIpOwogICAgICB2YXIgbG9hZGluZ0JhciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIiN1bml0eS1sb2FkaW5nLWJhciIpOwogICAgICB2YXIgcHJvZ3Jlc3NCYXJGdWxsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI3VuaXR5LXByb2dyZXNzLWJhci1mdWxsIik7CiAgICAgIHZhciBmdWxsc2NyZWVuQnV0dG9uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI3VuaXR5LWZ1bGxzY3JlZW4tYnV0dG9uIik7CgogICAgICBpZiAoL2lQaG9uZXxpUGFkfGlQb2R8QW5kcm9pZC9pLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHsKICAgICAgICBjb250YWluZXIuY2xhc3NOYW1lID0gInVuaXR5LW1vYmlsZSI7CiAgICAgICAgY29uZmlnLmRldmljZVBpeGVsUmF0aW8gPSAxOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbnZhcy5zdHlsZS53aWR0aCA9ICI5NjBweCI7CiAgICAgICAgY2FudmFzLnN0eWxlLmhlaWdodCA9ICI1NDBweCI7CiAgICAgIH0KICAgICAgbG9hZGluZ0Jhci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCiAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgc2NyaXB0LnNyYyA9IGxvYWRlclVybDsKICAgICAgc2NyaXB0Lm9ubG9hZCA9ICgpID0+IHsKICAgICAgICBjcmVhdGVVbml0eUluc3RhbmNlKGNhbnZhcywgY29uZmlnLCAocHJvZ3Jlc3MpID0+IHsKICAgICAgICAgIHByb2dyZXNzQmFyRnVsbC5zdHlsZS53aWR0aCA9IDEwMCAqIHByb2dyZXNzICsgIiUiOwogICAgICAgIH0pLnRoZW4oKHVuaXR5SW5zdGFuY2UpID0+IHsKICAgICAgICAgIGxvYWRpbmdCYXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgIGZ1bGxzY3JlZW5CdXR0b24ub25jbGljayA9ICgpID0+IHsKICAgICAgICAgICAgdW5pdHlJbnN0YW5jZS5TZXRGdWxsc2NyZWVuKDEpOwogICAgICAgICAgfTsKICAgICAgICB9KS5jYXRjaCgobWVzc2FnZSkgPT4gewogICAgICAgICAgYWxlcnQobWVzc2FnZSk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgIDwvc2NyaXB0PgogIDwvYm9keT4KPC9odG1sPg==`));
 
 const OGchangeURL = changeURL;
 window.changeURL = function(url) {
  console.log(url);
  var noSearch = url.split("?")[0];
  var noThisFolder = url.split("./")[1];
  if (!window.fileList[url] && window.fileList[noSearch]) {
   url = noSearch;
  }
  if (!window.fileList[url] && window.fileList[noThisFolder]) {
   url = noThisFolder;
  }
  return OGchangeURL(url);
 }
 
 const originalOpen = frameWindow.XMLHttpRequest.prototype.open;
 Object.defineProperty(frameWindow.XMLHttpRequest.prototype, "open", {
  value: function() {
   arguments[1] = changeURL(arguments[1]);
   return originalOpen.apply(this, arguments);
  }
 });
 
 frameWindow.document.close();
 frameWindow.fetch = window.fetch;
 frameWindow.fetch = window.fetch;
});
    </script>
  </head>
</html>
